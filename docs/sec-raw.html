<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Chapter 3 Raw MS data | R for Mass Spectrometry" />
<meta property="og:type" content="book" />




<meta name="author" content="Laurent Gatto, Sebastian Gibb, Johannes Rainer" />

<meta name="date" content="2025-06-05" />


<meta name="description" content="Chapter 3 Raw MS data | R for Mass Spectrometry">

<title>Chapter 3 Raw MS data | R for Mass Spectrometry</title>

<link href="libs/tufte-css-2015.12.29/tufte.css" rel="stylesheet" />
<link href="libs/tufte-css-2015.12.29/envisioned.css" rel="stylesheet" />
<link href="libs/msmb-css-0/msmb.css" rel="stylesheet" />
<script>
function toggle_visibility(id1, id2) {
var e = document.getElementById(id1);
var f = document.getElementById(id2);

e.style.display = ((e.style.display!='none') ? 'none' : 'block');

if(f.classList.contains('fa-plus-square')) {
    f.classList.add('fa-minus-square')
    f.classList.remove('fa-plus-square')
} else {
    f.classList.add('fa-plus-square')
    f.classList.remove('fa-minus-square')
}

}
</script>
<script>
function copy_link(id) {
  var dummy = document.createElement('input'),
  text = window.location.href.split(/[?#]/)[0] + '#' + id;
  document.body.appendChild(dummy);
  dummy.value = text;
  dummy.select();
  document.execCommand('copy');
  document.body.removeChild(dummy);
  
  var tooltip = document.getElementById(id + '-tooltip');
  tooltip.innerHTML = 'Copied!';
}

function reset_tooltip(id) {
  var tooltip = document.getElementById(id);
  tooltip.innerHTML = 'Copy link';
}
</script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }

code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #204a87; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #204a87; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>


<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>



<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul class="navbar">
<li class="msmb"><p class="title">R for Mass Spectrometry<p><p class="author">Laurent Gatto, Sebastian Gibb, Johannes Rainer</p>
<li class="dropdown" style="float:right">
<a href="javascript:void(0)" class="dropbtn">&#x25BE; Chapters</a>
<div class="dropdown-content">
<a href="index.html" id="toc-preamble"><span class="toc-section-number">1</span> Preamble</a>
<a href="sec-msintro.html" id="toc-sec-msintro"><span class="toc-section-number">2</span> Introduction</a>
<a id="active-page" href="sec-raw.html" id="toc-sec-raw"><span class="toc-section-number">3</span> Raw MS data</a><ul class="toc-sections">
<li class="toc"><a href="#what-is-raw-data-in-r"> What is raw data in R</a></li>
<li class="toc"><a href="#visualisation-of-raw-ms-data"> Visualisation of raw MS data</a></li>
<li class="toc"><a href="#raw-data-processing-and-manipulation"> Raw data processing and manipulation</a></li>
<li class="toc"><a href="#a-note-on-efficiency"> A note on efficiency</a></li>
</ul>
<a href="sec-id.html" id="toc-sec-id"><span class="toc-section-number">4</span> Identification data</a>
<a href="sec-quant.html" id="toc-sec-quant"><span class="toc-section-number">5</span> Quantitative data</a>
<a href="sec-anx.html" id="toc-sec-anx"><span class="toc-section-number">6</span> Annex</a>
<a href="sec-si.html" id="toc-sec-si"><span class="toc-section-number">7</span> Additional materials and session information</a>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="sec-raw" class="section level1" number="3">
<h1>
<span class="header-section-number">Chapter 3</span> Raw MS data</h1>
<p>In this section, we will learn how to read raw data in one of the
commonly used open formats (<code>mzML</code>, <code>mzXML</code>, <code>netCDF</code> or <code>mgf</code>) into
R.</p>
<div id="what-is-raw-data-in-r" class="section level2" number="3.1">
<h2>
<span class="header-section-number">3.1</span> What is raw data in R<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('what-is-raw-data-in-r')" onmouseout="reset_tooltip('what-is-raw-data-in-r-tooltip')"><span class="tooltiptext" id="what-is-raw-data-in-r-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>When we manipulate complex data, we need a way to abstract it.</p>
<p>The abstraction saves us from having to know about all
the details of that data <strong>and</strong> its associated metadata. In R, we
think of MS data as illustrated on the figure below (taken from
<span class="citation">(<label for="tufte-mn-5" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-5" class="margin-toggle">Gatto, Gibb, and Rainer 2020<span class="marginnote">Gatto, Laurent, Sebastian Gibb, and Johannes Rainer. 2020. <span>“<span>MSnbase</span>, Efficient and Elegant r-Based Processing and Visualisation of Raw Mass Spectrometry Data.”</span> <em>J. Proteome Res.</em>, September.</span>)</span>): a metadata table and a set of raw spectra. This allows
to rely on a few easy-to-remember conventions to make mundane and
repetitive tasks trivial and be able to complete more complex things
easily. Abstractions provide a smoother approach to handle complex
data using common patterns.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-9"></span>
<p class="caption marginnote shownote">
Figure 3.1: Schematic representation of what is referred to by <em>raw data</em>: a collection of mass spectra and a table containing spectrum-level annotations along the lines. Raw data are imported from one of the many community-maintained open standards formats (mzML, mzXML, mzData or ANDI-MS/netCDF).
</p>
<img src="img/raw.png" alt="Schematic representation of what is referred to by *raw data*: a collection of mass spectra and a table containing spectrum-level annotations along the lines. Raw data are imported from one of the many community-maintained open standards formats (mzML, mzXML, mzData or ANDI-MS/netCDF)." width="100%">
</div>
<div id="the-spectra-class" class="section level3" number="3.1.1">
<h3>
<span class="header-section-number">3.1.1</span> The <code>Spectra</code> class<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('the-spectra-class')" onmouseout="reset_tooltip('the-spectra-class-tooltip')"><span class="tooltiptext" id="the-spectra-class-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>We are going to use the
<a href="https://rformassspectrometry.github.io/Spectra/"><code>Spectra</code></a> package
as an abstraction to raw mass spectrometry data.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="sec-raw.html#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Spectra)</span></code></pre></div>
<p><code>Spectra</code> is part of the <a href="https://www.rformassspectrometry.org/">R for Mass Spectrometry
initiative</a>. It
defines the <code>Spectra</code> class that is used as a raw data abstraction, to
manipulate MS data and metadata. The best way to learn about a data
structure is to create one by hand.</p>
<p>Let’s create a <code>DataFrame</code><label for="tufte-sn-4" class="margin-toggle sidenote-number">4</label><input type="checkbox" id="tufte-sn-4" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">4</span> As defined in the Bioconductor <code>S4Vectors</code>
package.</span> containing MS levels, retention time, m/z and intensities
for 2 spectra:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="sec-raw.html#cb39-1" aria-hidden="true" tabindex="-1"></a>spd <span class="ot">&lt;-</span> <span class="fu">DataFrame</span>(<span class="at">msLevel =</span> <span class="fu">c</span>(1L, 2L), <span class="at">rtime =</span> <span class="fu">c</span>(<span class="fl">1.1</span>, <span class="fl">1.2</span>))</span>
<span id="cb39-2"><a href="sec-raw.html#cb39-2" aria-hidden="true" tabindex="-1"></a>spd<span class="sc">$</span>mz <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">100</span>, <span class="fl">103.2</span>, <span class="fl">104.3</span>, <span class="fl">106.5</span>), <span class="fu">c</span>(<span class="fl">45.6</span>, <span class="fl">120.4</span>, <span class="fl">190.2</span>))</span>
<span id="cb39-3"><a href="sec-raw.html#cb39-3" aria-hidden="true" tabindex="-1"></a>spd<span class="sc">$</span>intensity <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">200</span>, <span class="dv">400</span>, <span class="fl">34.2</span>, <span class="dv">17</span>), <span class="fu">c</span>(<span class="fl">12.3</span>, <span class="fl">15.2</span>, <span class="fl">6.8</span>))</span>
<span id="cb39-4"><a href="sec-raw.html#cb39-4" aria-hidden="true" tabindex="-1"></a>spd</span></code></pre></div>
<pre><code>## DataFrame with 2 rows and 4 columns
##     msLevel     rtime                    mz             intensity
##   &lt;integer&gt; &lt;numeric&gt;                &lt;list&gt;                &lt;list&gt;
## 1         1       1.1 100.0,103.2,104.3,... 200.0,400.0, 34.2,...
## 2         2       1.2      45.6,120.4,190.2        12.3,15.2, 6.8</code></pre>
<p>And now convert this <code>DataFrame</code> into a <code>Spectra</code> object:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="sec-raw.html#cb41-1" aria-hidden="true" tabindex="-1"></a>sp0 <span class="ot">&lt;-</span> <span class="fu">Spectra</span>(spd)</span>
<span id="cb41-2"><a href="sec-raw.html#cb41-2" aria-hidden="true" tabindex="-1"></a>sp0</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 2 spectra in a MsBackendMemory backend:
##     msLevel     rtime scanIndex
##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1         1       1.1        NA
## 2         2       1.2        NA
##  ... 16 more variables/columns.</code></pre>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Explore the newly created object using</p>
<ul>
<li>
<code>spectraVariables</code> to extract all the metadata variables. Compare these to the
spectra variables available from the previous example.</li>
<li>
<code>spectraData</code> to extract all the metadata.</li>
<li>
<code>peaksData</code> to extract a list containing the raw data.</li>
<li>
<code>[</code> to create subsets.</li>
</ul>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
</div>
<div id="spectra-from-mzml-files" class="section level3" number="3.1.2">
<h3>
<span class="header-section-number">3.1.2</span> <code>Spectra</code> from mzML files<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('spectra-from-mzml-files')" onmouseout="reset_tooltip('spectra-from-mzml-files-tooltip')"><span class="tooltiptext" id="spectra-from-mzml-files-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>Let’s now create a new object using the mzML data previously
downloaded and available in the <code>mzf</code> file.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="sec-raw.html#cb43-1" aria-hidden="true" tabindex="-1"></a>mzf</span></code></pre></div>
<pre><code>## [1] "/home/lgatto/.cache/R/rpx/184155b6efdb_TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01-20141210.mzML"</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="sec-raw.html#cb45-1" aria-hidden="true" tabindex="-1"></a>sp <span class="ot">&lt;-</span> <span class="fu">Spectra</span>(mzf)</span>
<span id="cb45-2"><a href="sec-raw.html#cb45-2" aria-hidden="true" tabindex="-1"></a>sp</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 7534 spectra in a MsBackendMzR backend:
##        msLevel     rtime scanIndex
##      &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1            1    0.4584         1
## 2            1    0.9725         2
## 3            1    1.8524         3
## 4            1    2.7424         4
## 5            1    3.6124         5
## ...        ...       ...       ...
## 7530         2   3600.47      7530
## 7531         2   3600.83      7531
## 7532         2   3601.18      7532
## 7533         2   3601.57      7533
## 7534         2   3601.98      7534
##  ... 34 more variables/columns.
## 
## file(s):
## 184155b6efdb_TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01-20141210.mzML</code></pre>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<ul>
<li>Repeat the data manipulations above.</li>
<li>Check the number of scans in the object with <code>length()</code>.</li>
<li>Note the difference in the first line when showing the object in the
console. We will get back to this idea of backend later.</li>
</ul>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<p>Mass spectrometry data in <code>Spectra</code> objects can be thought of as a
list of individual spectra, with each spectrum having a set of
variables associated with it. Besides <em>core</em> spectra variables (such
as MS level or retention time) an arbitrary number of optional
variables can be assigned to a spectrum. The core spectra variables
all have their own accessor method and it is guaranteed that a value
is returned by it (or <code>NA</code> if the information is not available). The
core variables and their data type are (alphabetically ordered):</p>
<ul>
<li>
<em>acquisitionNum</em> <code>integer(1)</code>: the index of acquisition of a
spectrum during a MS run.</li>
<li>
<em>centroided</em> <code>logical(1)</code>: whether the spectrum is in profile or
centroid mode.</li>
<li>
<em>collisionEnergy</em> <code>numeric(1)</code>: collision energy used to create an
MSn spectrum.</li>
<li>
<em>dataOrigin</em> <code>character(1)</code>: the <em>origin</em> of the spectrum’s data,
e.g. the mzML file from which it was read.</li>
<li>
<em>dataStorage</em> <code>character(1)</code>: the (current) storage location of the
spectrum data. This value depends on the backend used to handle and
provide the data. For an <em>in-memory</em> backend like the
<code>MsBackendMemory</code> this will be <code>"&lt;memory&gt;"</code>, for an on-disk
backend such as the <code>MsBackendHdf5Peaks</code> it will be the name of the
HDF5 file where the spectrum’s peak data is stored.</li>
<li>
<em>intensity</em> <code>numeric</code>: intensity values for the spectrum’s peaks.</li>
<li>
<em>isolationWindowLowerMz</em> <code>numeric(1)</code>: lower m/z for the isolation
window in which the (MSn) spectrum was measured.</li>
<li>
<em>isolationWindowTargetMz</em> <code>numeric(1)</code>: the target m/z for the
isolation window in which the (MSn) spectrum was measured.</li>
<li>
<em>isolationWindowUpperMz</em> <code>numeric(1)</code>: upper m/z for the isolation
window in which the (MSn) spectrum was measured.</li>
<li>
<em>msLevel</em> <code>integer(1)</code>: the MS level of the spectrum.</li>
<li>
<em>mz</em> <code>numeric</code>: the m/z values for the spectrum’s peaks.</li>
<li>
<em>polarity</em> <code>integer(1)</code>: the polarity of the spectrum (<code>0</code> and <code>1</code>
representing negative and positive polarity, respectively).</li>
<li>
<em>precScanNum</em> <code>integer(1)</code>: the scan (acquisition) number of the
precursor for an MSn spectrum.</li>
<li>
<em>precursorCharge</em> <code>integer(1)</code>: the charge of the precursor of an
MSn spectrum.</li>
<li>
<em>precursorIntensity</em> <code>numeric(1)</code>: the intensity of the precursor of
an MSn spectrum.</li>
<li>
<em>precursorMz</em> <code>numeric(1)</code>: the m/z of the precursor of an MSn
spectrum.</li>
<li>
<em>rtime</em> <code>numeric(1)</code>: the retention time of a spectrum.</li>
<li>
<em>scanIndex</em> <code>integer(1)</code>: the index of a spectrum within a (raw)
file.</li>
<li>
<em>smoothed</em> <code>logical(1)</code>: whether the spectrum was smoothed.</li>
</ul>
<p>For details on the individual variables and their getter/setter
function see the help for <code>Spectra</code> (<code>?Spectra</code>). Also note that these
variables are suggested, but not required to characterize a
spectrum. Also, some only make sense for MSn, but not for MS1 spectra.</p>
<p>In addition to the core spectra variables it is also possible to add additional
spectra variables to a <code>Spectra</code> object. As an example we add below a spectra
variable representing the retention times in minutes to the object. This
information can then be extracted again using the <code>$</code> notation (similar to
accessing a column in a <code>data.frame</code>, i.e., <code>$</code> and the name of the spectra
variable).</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="sec-raw.html#cb47-1" aria-hidden="true" tabindex="-1"></a>sp<span class="sc">$</span>rtime_minute <span class="ot">&lt;-</span> <span class="fu">rtime</span>(sp) <span class="sc">/</span> <span class="dv">60</span></span>
<span id="cb47-2"><a href="sec-raw.html#cb47-2" aria-hidden="true" tabindex="-1"></a>sp<span class="sc">$</span>rtime_minute <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code></pre></div>
<pre><code>## [1] 0.00764000 0.01620833 0.03087333 0.04570667 0.06020667 0.07487500</code></pre>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<ul>
<li>Extract a set of spectra variables using the accessor (for example
<code>msLevel(.)</code>) or using the <code>$</code> notation (for example <code>.$msLevel</code>).</li>
<li>How many MS level are there, and how many scans of each level?</li>
<li>Extract the index of the MS2 spectrum with the highest base peak
intensity.</li>
<li>Are the data centroided or in profile mode?</li>
<li>Pick a spectrum of each level and visually check whether it is
centroided or in profile mode. You can use the <code>plotSpectra()</code>
function to visualise peaks and set the m/z range with the <code>xlim</code>
arguments.</li>
</ul>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Using the first raw data file starting with <code>MS3TMT10</code>, answer the
following questions:</p>
<ul>
<li>How many spectra are there in that file?</li>
<li>How many MS levels, and how many spectra per MS level?</li>
<li>What is the index of the MS2 spectrum with the highest precursor
intensity?</li>
<li>Plot one spectrum of each level. Are they centroided or in profile
mode?</li>
</ul>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<p>These objects and their manipulations are not limited to single files or
samples. Below we load data from two mzML files. The MS data from both files in
the <code>Spectra</code> is organized linearly (first all spectra from the first file
and then from the second). The <code>dataOrigin</code> function can be used to identify
spectra from the different data files.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="sec-raw.html#cb49-1" aria-hidden="true" tabindex="-1"></a>(fls <span class="ot">&lt;-</span> <span class="fu">dir</span>(<span class="fu">system.file</span>(<span class="st">"sciex"</span>, <span class="at">package =</span> <span class="st">"msdata"</span>), <span class="at">full.names =</span> <span class="cn">TRUE</span>))</span></code></pre></div>
<pre><code>## [1] "/gnu/store/jva50sd5pnbdvjpya85sg9sqrrw113cl-r-msdata-0.48.0/site-library/msdata/sciex/20171016_POOL_POS_1_105-134.mzML"
## [2] "/gnu/store/jva50sd5pnbdvjpya85sg9sqrrw113cl-r-msdata-0.48.0/site-library/msdata/sciex/20171016_POOL_POS_3_105-134.mzML"</code></pre>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="sec-raw.html#cb51-1" aria-hidden="true" tabindex="-1"></a>sp_sciex <span class="ot">&lt;-</span> <span class="fu">Spectra</span>(fls)</span>
<span id="cb51-2"><a href="sec-raw.html#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">dataOrigin</span>(sp_sciex))</span></code></pre></div>
<pre><code>## 
## /gnu/store/jva50sd5pnbdvjpya85sg9sqrrw113cl-r-msdata-0.48.0/site-library/msdata/sciex/20171016_POOL_POS_1_105-134.mzML 
##                                                                                                                    931 
## /gnu/store/jva50sd5pnbdvjpya85sg9sqrrw113cl-r-msdata-0.48.0/site-library/msdata/sciex/20171016_POOL_POS_3_105-134.mzML 
##                                                                                                                    931</code></pre>
</div>
<div id="backends" class="section level3" number="3.1.3">
<h3>
<span class="header-section-number">3.1.3</span> Backends<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('backends')" onmouseout="reset_tooltip('backends-tooltip')"><span class="tooltiptext" id="backends-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>Backends allow to use different <em>backends</em> to store mass spectrometry data while
providing <em>via</em> the <code>Spectra</code> class a unified interface to use that data. With
the <code>setBackend</code> function it is possible to change between different backends
and hence different data representations. The <code>Spectra</code> package defines a set of
example backends but any object extending the base <code>MsBackend</code> class could be
used instead. The default backends are:</p>
<ul>
<li>
<code>MsBackendMzR</code>: this backend keeps only general spectra variables in memory
and relies on the <em><a href="https://bioconductor.org/packages/3.21/mzR">mzR</a></em> package to read mass peaks (m/z and
intensity values) from the original MS files on-demand.</li>
</ul>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="sec-raw.html#cb53-1" aria-hidden="true" tabindex="-1"></a>sp_sciex</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 1862 spectra in a MsBackendMzR backend:
##        msLevel     rtime scanIndex
##      &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1            1     0.280         1
## 2            1     0.559         2
## 3            1     0.838         3
## 4            1     1.117         4
## 5            1     1.396         5
## ...        ...       ...       ...
## 1858         1   258.636       927
## 1859         1   258.915       928
## 1860         1   259.194       929
## 1861         1   259.473       930
## 1862         1   259.752       931
##  ... 34 more variables/columns.
## 
## file(s):
## 20171016_POOL_POS_1_105-134.mzML
## 20171016_POOL_POS_3_105-134.mzML</code></pre>
<ul>
<li>
<code>MsBackendMemory</code> and <code>MsBackendDataFrame</code>: the full mass spectrometry data is
stored (in-memory) within the object. Keeping the data in memory guarantees
high performance but has also, depending on the number of mass peaks in each
spectrum, a much higher memory footprint.</li>
</ul>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="sec-raw.html#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setBackend</span>(sp_sciex, <span class="fu">MsBackendMemory</span>())</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 1862 spectra in a MsBackendMemory backend:
##        msLevel     rtime scanIndex
##      &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1            1     0.280         1
## 2            1     0.559         2
## 3            1     0.838         3
## 4            1     1.117         4
## 5            1     1.396         5
## ...        ...       ...       ...
## 1858         1   258.636       927
## 1859         1   258.915       928
## 1860         1   259.194       929
## 1861         1   259.473       930
## 1862         1   259.752       931
##  ... 34 more variables/columns.
## Processing:
##  Switch backend from MsBackendMzR to MsBackendMemory [Thu Jun  5 17:25:47 2025]</code></pre>
<ul>
<li>
<code>MsBackendHdf5Peaks</code>: similar to <code>MsBackendMzR</code> this backend reads peak data
only on-demand from disk while all other spectra variables are kept in
memory. The peak data are stored in Hdf5 files which guarantees scalability.</li>
</ul>
<p>With the example below we load the data from a single mzML file and use a
<code>MsBackendHdf5Peaks</code> backend for data storage. The <code>hdf5path</code> parameter allows
us to specify the storage location of the HDF5 file.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="sec-raw.html#cb57-1" aria-hidden="true" tabindex="-1"></a>sp_hdf5 <span class="ot">&lt;-</span> <span class="fu">setBackend</span>(sp_sciex, <span class="fu">MsBackendHdf5Peaks</span>(), <span class="at">hdf5path =</span> <span class="fu">tempdir</span>())</span>
<span id="cb57-2"><a href="sec-raw.html#cb57-2" aria-hidden="true" tabindex="-1"></a>sp_hdf5</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 1862 spectra in a MsBackendHdf5Peaks backend:
##        msLevel     rtime scanIndex
##      &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1            1     0.280         1
## 2            1     0.559         2
## 3            1     0.838         3
## 4            1     1.117         4
## 5            1     1.396         5
## ...        ...       ...       ...
## 1858         1   258.636       927
## 1859         1   258.915       928
## 1860         1   259.194       929
## 1861         1   259.473       930
## 1862         1   259.752       931
##  ... 34 more variables/columns.
## 
## file(s):
##  20171016_POOL_POS_1_105-134.h5
##  20171016_POOL_POS_3_105-134.h5
## Processing:
##  Switch backend from MsBackendMzR to MsBackendHdf5Peaks [Thu Jun  5 17:25:58 2025]</code></pre>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="sec-raw.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(sp_hdf5<span class="sc">$</span>dataOrigin)</span></code></pre></div>
<pre><code>## 
## /gnu/store/jva50sd5pnbdvjpya85sg9sqrrw113cl-r-msdata-0.48.0/site-library/msdata/sciex/20171016_POOL_POS_1_105-134.mzML 
##                                                                                                                    931 
## /gnu/store/jva50sd5pnbdvjpya85sg9sqrrw113cl-r-msdata-0.48.0/site-library/msdata/sciex/20171016_POOL_POS_3_105-134.mzML 
##                                                                                                                    931</code></pre>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="sec-raw.html#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(sp_hdf5<span class="sc">$</span>dataStorage)</span></code></pre></div>
<pre><code>## 
## /tmp/Rtmp5s5cX4/20171016_POOL_POS_1_105-134.h5 
##                                            931 
## /tmp/Rtmp5s5cX4/20171016_POOL_POS_3_105-134.h5 
##                                            931</code></pre>
<p>All of the above mentioned backends support changing all of their their spectra
variables, <strong>except</strong> the <code>MsBackendMzR</code> that does not support changing m/z or
intensity values for the mass peaks.</p>
<p>Next to these default backends there are a set of other backend implementations
provided by additional R packages. The
<a href="https://rformassspectrometry.github.io/MsBackendSql"><code>MsBackendSql</code></a> for
example allows to store (and retrieve) all MS data in (from) an SQL database
guaranteeing thus a minimal memory footprint.</p>
<p>Other backends focus on specific file formats such as
<a href="https://rformassspectrometry.github.io/MsBackendMgf/"><code>MsBackendMgf</code></a> for files
in <code>mgf</code> file format or on specific acquisitions such as
<a href="https://rformassspectrometry.github.io/MsBackendTimsTof/"><code>MsBackendTimsTof</code></a>
or provide access to certain MS data resources such as the
<a href="https://rformassspectrometry.github.io/MsBackendMassbank/"><code>MsBackendMassbank</code></a>.
Additional backends are being developed to address specific needs or
technologies, while remaining compliant with the <code>Spectra</code> interface.</p>
<p>If you would like to learn more about how the raw MS formats are
handled by <code>Spectra</code> via the <em><a href="https://bioconductor.org/packages/3.21/mzR">mzR</a></em> package,
check out the <a href="sec-anx.html#sec-raw2">6.1</a> section in the annex.</p>
<p>See also <a href="https://jorainer.github.io/SpectraTutorials/articles/Spectra-backends.html">Spectra
backends</a>
for more information on different backends, their properties and
advantages/disadvantages.</p>
</div>
</div>
<div id="visualisation-of-raw-ms-data" class="section level2" number="3.2">
<h2>
<span class="header-section-number">3.2</span> Visualisation of raw MS data<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('visualisation-of-raw-ms-data')" onmouseout="reset_tooltip('visualisation-of-raw-ms-data-tooltip')"><span class="tooltiptext" id="visualisation-of-raw-ms-data-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>The importance of flexible access to specialised data becomes visible
in the figure below (taken from the <code>RforProteomics</code> <a href="http://bioconductor.org/packages/release/data/experiment/vignettes/RforProteomics/inst/doc/RProtVis.html">visualisation
vignette</a>).
Not only can we access specific data and understand/visualise them,
but we can transverse all the data and extract/visualise/understand
structured slices of data.</p>
<p>The figure below shows an illustration of how mass spectrometry
works:</p>
<ol style="list-style-type: decimal">
<li><p>The chromatogram at the top displays the total ion current along the
retention time. The vertical line identifies one scan in particular
at retention time 1800.68 seconds (the 2807th scan).</p></li>
<li><p>The spectra on the second line represent the full MS1 spectrum
marked by the red line. The vertical lines identify the 10
precursor ions that where selected for MS2 analysis. The zoomed in
on the right shows one specific precursor peak.</p></li>
<li><p>The MS2 spectra displayed along the two rows at the bottom are
those resulting from the fragmentation of the 10 precursor peaks
identified by the vertical bars above.</p></li>
</ol>
<p><img src="img/msvisfig.png" width="100%" style="display: block; margin: auto;"></p>
<p>We are going to reproduce the figure above through a set of exercices.</p>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<ol style="list-style-type: decimal">
<li>The chromatogram can be created by extracting the <code>totIonCurrent</code>
and <code>rtime</code> variables for all MS1 spectra. Annotate the spectrum of
interest.</li>
</ol>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="msmb-solution">
<p class="solution-begin">
► Solution<span id="sol-start-1" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-1', 'sol-start-1')"></span>
</p>
<div id="sol-body-1" class="solution-body" style="display: none;">
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="sec-raw.html#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(<span class="fu">spectraData</span>(<span class="fu">filterMsLevel</span>(sp, <span class="dv">1</span>)),</span>
<span id="cb63-2"><a href="sec-raw.html#cb63-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">plot</span>(rtime, totIonCurrent, <span class="at">type =</span> <span class="st">"l"</span>))</span>
<span id="cb63-3"><a href="sec-raw.html#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="fu">rtime</span>(sp)[<span class="dv">2807</span>], <span class="at">col =</span> <span class="st">"red"</span>)</span></code></pre></div>
<p><img src="R4MS_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<ol start="2" style="list-style-type: decimal">
<li>The <code>filterPrecursorScan()</code> function can be used to retain a set
parent (MS1) and children scans (MS2), as defined by an acquisition
number. Use it to extract the MS1 scan of interest and all its MS2
children.</li>
</ol>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="msmb-solution">
<p class="solution-begin">
► Solution<span id="sol-start-2" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-2', 'sol-start-2')"></span>
</p>
<div id="sol-body-2" class="solution-body" style="display: none;">
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="sec-raw.html#cb64-1" aria-hidden="true" tabindex="-1"></a>ms_2 <span class="ot">&lt;-</span> <span class="fu">filterPrecursorScan</span>(sp, <span class="dv">2807</span>)</span>
<span id="cb64-2"><a href="sec-raw.html#cb64-2" aria-hidden="true" tabindex="-1"></a>ms_2</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 11 spectra in a MsBackendMzR backend:
##      msLevel     rtime scanIndex
##    &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1          1   1800.68      2807
## 2          2   1801.26      2808
## 3          2   1801.92      2809
## 4          2   1802.20      2810
## 5          2   1802.48      2811
## 6          2   1802.77      2812
## 7          2   1803.05      2813
## 8          2   1803.34      2814
## 9          2   1803.64      2815
## 10         2   1803.93      2816
## 11         2   1804.21      2817
##  ... 35 more variables/columns.
## 
## file(s):
## 184155b6efdb_TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01-20141210.mzML
## Processing:
##  Filter: select parent/children scans for 2807 [Thu Jun  5 17:25:58 2025]</code></pre>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<ol start="3" style="list-style-type: decimal">
<li>Plot the MS1 spectrum of interest and highlight all the peaks that
will be selected for MS2 analysis.</li>
</ol>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="msmb-solution">
<p class="solution-begin">
► Solution<span id="sol-start-3" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-3', 'sol-start-3')"></span>
</p>
<div id="sol-body-3" class="solution-body" style="display: none;">
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="sec-raw.html#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpectra</span>(sp[<span class="dv">2807</span>], <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">400</span>, <span class="dv">1000</span>))</span>
<span id="cb66-2"><a href="sec-raw.html#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="fu">precursorMz</span>(ms_2)[<span class="sc">-</span><span class="dv">1</span>], <span class="at">col =</span> <span class="st">"grey"</span>)</span>
<span id="cb66-3"><a href="sec-raw.html#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="fu">precursorMz</span>(ms_2)[<span class="dv">2</span>], <span class="at">col =</span> <span class="st">"red"</span>)</span></code></pre></div>
<p><img src="R4MS_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<ol start="4" style="list-style-type: decimal">
<li>Zoom in mz values 521.1 and 522.5 to reveal the isotopic envelope
of that peak.</li>
</ol>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="msmb-solution">
<p class="solution-begin">
► Solution<span id="sol-start-4" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-4', 'sol-start-4')"></span>
</p>
<div id="sol-body-4" class="solution-body" style="display: none;">
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="sec-raw.html#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpectra</span>(sp[<span class="dv">2807</span>], <span class="at">xlim =</span> <span class="fu">c</span>(<span class="fl">521.2</span>, <span class="fl">522.5</span>), <span class="at">type =</span> <span class="st">"l"</span>)</span>
<span id="cb67-2"><a href="sec-raw.html#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="fu">precursorMz</span>(ms_2)[<span class="dv">2</span>], <span class="at">col =</span> <span class="st">"red"</span>)</span></code></pre></div>
<p><img src="R4MS_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<ol start="5" style="list-style-type: decimal">
<li>The <code>plotSpectra()</code> function is used to plot all 10 MS2 spectra in
one call.</li>
</ol>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="msmb-solution">
<p class="solution-begin">
► Solution<span id="sol-start-5" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-5', 'sol-start-5')"></span>
</p>
<div id="sol-body-5" class="solution-body" style="display: none;">
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="sec-raw.html#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpectra</span>(ms_2[<span class="sc">-</span><span class="dv">1</span>])</span></code></pre></div>
<p><img src="R4MS_files/figure-html/unnamed-chunk-17-1.png" width="768"></p>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<p>It is possible to label the peaks with the <code>plotSpectra()</code>
function. The <code>labels</code> argument is either a <code>character</code> of appropriate
length (i.e. with a label for each peak) or, as illustrated below, a
function that computes the labels.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="sec-raw.html#cb69-1" aria-hidden="true" tabindex="-1"></a>mzLabel <span class="ot">&lt;-</span> <span class="cf">function</span>(z) {</span>
<span id="cb69-2"><a href="sec-raw.html#cb69-2" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> <span class="fu">peaksData</span>(z)[[1L]]</span>
<span id="cb69-3"><a href="sec-raw.html#cb69-3" aria-hidden="true" tabindex="-1"></a>    lbls <span class="ot">&lt;-</span> <span class="fu">format</span>(z[, <span class="st">"mz"</span>], <span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb69-4"><a href="sec-raw.html#cb69-4" aria-hidden="true" tabindex="-1"></a>    lbls[z[, <span class="st">"intensity"</span>] <span class="sc">&lt;</span> <span class="fl">1e5</span>] <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb69-5"><a href="sec-raw.html#cb69-5" aria-hidden="true" tabindex="-1"></a>    lbls</span>
<span id="cb69-6"><a href="sec-raw.html#cb69-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-7"><a href="sec-raw.html#cb69-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-8"><a href="sec-raw.html#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpectra</span>(ms_2[<span class="dv">7</span>],</span>
<span id="cb69-9"><a href="sec-raw.html#cb69-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">126</span>, <span class="dv">132</span>),</span>
<span id="cb69-10"><a href="sec-raw.html#cb69-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">labels =</span> mzLabel,</span>
<span id="cb69-11"><a href="sec-raw.html#cb69-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">labelSrt =</span> <span class="sc">-</span><span class="dv">30</span>, <span class="at">labelPos =</span> <span class="dv">2</span>,</span>
<span id="cb69-12"><a href="sec-raw.html#cb69-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">labelOffset =</span> <span class="fl">0.1</span>)</span></code></pre></div>
<p><img src="R4MS_files/figure-html/unnamed-chunk-18-1.png" width="672"></p>
<p>Spectra can also be compared either by overlay or mirror plotting
using the <code>plotSpectraOverlay()</code> and <code>plotSpectraMirror()</code> functions.</p>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Filter MS2 level spectra and find any 2 MS2 spectra that have matching
precursor peaks based on the precursor m/z values.</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="msmb-solution">
<p class="solution-begin">
► Solution<span id="sol-start-6" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-6', 'sol-start-6')"></span>
</p>
<div id="sol-body-6" class="solution-body" style="display: none;">
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="sec-raw.html#cb70-1" aria-hidden="true" tabindex="-1"></a>sp2 <span class="ot">&lt;-</span> <span class="fu">filterMsLevel</span>(sp, 2L)</span>
<span id="cb70-2"><a href="sec-raw.html#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">anyDuplicated</span>(<span class="fu">precursorMz</span>(<span class="fu">filterMsLevel</span>(sp, <span class="dv">2</span>)))</span></code></pre></div>
<pre><code>## [1] 37</code></pre>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="sec-raw.html#cb72-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">precursorMz</span>(sp2) <span class="sc">==</span> <span class="fu">precursorMz</span>(sp2)[<span class="dv">37</span>])</span>
<span id="cb72-2"><a href="sec-raw.html#cb72-2" aria-hidden="true" tabindex="-1"></a>sp2i <span class="ot">&lt;-</span> sp2[i]</span></code></pre></div>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Visualise the matching pair using the <code>plotSpectraOverlay()</code> and
<code>plotSpectraMirror()</code> functions.</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="msmb-solution">
<p class="solution-begin">
► Solution<span id="sol-start-7" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-7', 'sol-start-7')"></span>
</p>
<div id="sol-body-7" class="solution-body" style="display: none;">
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="sec-raw.html#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpectraOverlay</span>(sp2i, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"steelblue"</span>))</span></code></pre></div>
<p><img src="R4MS_files/figure-html/unnamed-chunk-20-1.png" width="672"></p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="sec-raw.html#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpectraMirror</span>(sp2i[<span class="dv">1</span>], sp2i[<span class="dv">2</span>])</span></code></pre></div>
<p><img src="R4MS_files/figure-html/unnamed-chunk-21-1.png" width="672"></p>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<p>It is also possible to explore raw data interactively with the
<a href="https://rformassspectrometry.github.io/SpectraVis/"><code>SpectraVis</code>
package</a>:</p>
<ul>
<li><p>The
<a href="https://rformassspectrometry.github.io/SpectraVis/reference/browseSpectra.html"><code>browseSpectra()</code></a>
function opens a simple shiny application that allows to browse
through the individual scans of a Spectra object.</p></li>
<li><p>The
<a href="https://rformassspectrometry.github.io/SpectraVis/reference/plotlySpectra.html"><code>plotlySpectra()</code></a>
function displays a single spectrum using
<a href="https://plotly.com/r/"><code>plotly</code></a> allowing to explore (zooming,
panning) the spectrum interactively.</p></li>
</ul>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Test the <code>SpectraVis</code> function on some the <code>Spectra</code> objects produce
above.</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
</div>
<div id="raw-data-processing-and-manipulation" class="section level2" number="3.3">
<h2>
<span class="header-section-number">3.3</span> Raw data processing and manipulation<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('raw-data-processing-and-manipulation')" onmouseout="reset_tooltip('raw-data-processing-and-manipulation-tooltip')"><span class="tooltiptext" id="raw-data-processing-and-manipulation-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>Apart from <em>classical</em> subsetting operations such as <code>[</code> and <code>split</code>, a set of
filter functions are defined for <code>Spectra</code> objects that filter/reduce the number
of spectra within the object (for detailed help please see the <code>?Spectra</code> help):</p>
<ul>
<li>
<code>filterAcquisitionNum</code>: retains spectra with certain acquisition numbers.</li>
<li>
<code>filterDataOrigin</code>: subsets to spectra from specific origins.</li>
<li>
<code>filterDataStorage</code>: subsets to spectra from certain data storage files.</li>
<li>
<code>filterEmptySpectra</code>: removes spectra without mass peaks.</li>
<li>
<code>filterMzRange</code>: subsets spectra keeping only peaks with an m/z within the
provided m/z range.</li>
<li>
<code>filterIsolationWindow</code>: keeps spectra with the provided <code>mz</code> in their
isolation window (m/z range).</li>
<li>
<code>filterMsLevel</code>: filters by MS level.</li>
<li>
<code>filterPolarity</code>: filters by polarity.</li>
<li>
<code>filterPrecursorIsotopes</code>: identifies precursor ions (from fragment spectra)
that could represent isotopes of the same molecule. For each of these spectra
groups only the spectrum of the monoisotopic precursor ion is returned. MS1
spectra are returned without filtering.</li>
<li>
<code>filterPrecursorMaxIntensity</code>: filters spectra keeping, for groups of spectra
with similar precursor m/z, the one spectrum with the highest precursor
intensity. All MS1 spectra are returned without filtering.</li>
<li>
<code>filterPrecursorMzRange</code>: retains (MSn) spectra with a precursor m/z within
the provided m/z range.</li>
<li>
<code>filterPrecursorMzValues</code>: retains (MSn) spectra with precursor m/z value
matching the provided value(s) considering also a <code>tolerance</code> and <code>ppm</code>.</li>
<li>
<code>filterPrecursorCharge</code>: retains (MSn) spectra with speified
precursor charge(s).</li>
<li>
<code>filterPrecursorScan</code>: retains (parent and children) scans of an acquisition
number.</li>
<li>
<code>filterRt</code>: filters based on retention time range.</li>
</ul>
<p>In addition to these, there is also a set of filter functions that operate on
the peak data, filtering and modifying the number of peaks of each spectrum
within a <code>Spectra</code>:</p>
<ul>
<li>
<code>combinePeaks</code>: groups peaks within each spectrum based on similarity of their
m/z values and combines these into a single peak per peak group.</li>
<li>
<code>deisotopeSpectra</code>: deisotopes each individual spectrum keeping only the
monoisotopic peak for peaks groups of potential isotopologues.</li>
<li>
<code>filterIntensity</code>: filter each spectrum keeping only peaks with intensities
meeting certain criteria.</li>
<li>
<code>filterMzRange</code>: subsets peaks data within each spectrum keeping only peaks
with their m/z values within the specified m/z range.</li>
<li>
<code>filterPrecursorPeaks</code>: removes peaks with either an m/z value matching the
precursor m/z of the respective spectrum (with parameter <code>mz = "=="</code>) or peaks
with an m/z value larger or equal to the precursor m/z (with parameter
<code>mz = "&gt;="</code>).</li>
<li>
<code>filterMzValues</code>: subsets peaks within each spectrum keeping or removing (all)
peaks matching provided m/z value(s) (given parameters <code>ppm</code> and <code>tolerance</code>).</li>
<li>
<code>reduceSpectra</code>: filters individual spectra keeping only the largest peak for
groups of peaks with similar m/z values.</li>
</ul>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Using the <code>sp_sciex</code> data, select all spectra measured in the second
mzML file and subsequently filter them to retain spectra measured
between 175 and 189 seconds in the measurement run.</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="msmb-solution">
<p class="solution-begin">
► Solution<span id="sol-start-8" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-8', 'sol-start-8')"></span>
</p>
<div id="sol-body-8" class="solution-body" style="display: none;">
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="sec-raw.html#cb75-1" aria-hidden="true" tabindex="-1"></a>fls <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">dataOrigin</span>(sp_sciex))</span>
<span id="cb75-2"><a href="sec-raw.html#cb75-2" aria-hidden="true" tabindex="-1"></a>fls</span></code></pre></div>
<pre><code>## [1] "/gnu/store/jva50sd5pnbdvjpya85sg9sqrrw113cl-r-msdata-0.48.0/site-library/msdata/sciex/20171016_POOL_POS_1_105-134.mzML"
## [2] "/gnu/store/jva50sd5pnbdvjpya85sg9sqrrw113cl-r-msdata-0.48.0/site-library/msdata/sciex/20171016_POOL_POS_3_105-134.mzML"</code></pre>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="sec-raw.html#cb77-1" aria-hidden="true" tabindex="-1"></a>file_2 <span class="ot">&lt;-</span> <span class="fu">filterDataOrigin</span>(sp_sciex, <span class="at">dataOrigin =</span> fls[<span class="dv">2</span>])</span>
<span id="cb77-2"><a href="sec-raw.html#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(file_2)</span></code></pre></div>
<pre><code>## [1] 931</code></pre>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="sec-raw.html#cb79-1" aria-hidden="true" tabindex="-1"></a>sps_sub <span class="ot">&lt;-</span> <span class="fu">filterRt</span>(file_2, <span class="at">rt =</span> <span class="fu">c</span>(<span class="dv">175</span>, <span class="dv">189</span>))</span>
<span id="cb79-2"><a href="sec-raw.html#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(sps_sub)</span></code></pre></div>
<pre><code>## [1] 50</code></pre>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="sec-raw.html#cb81-1" aria-hidden="true" tabindex="-1"></a>sp_sciex <span class="sc">|&gt;</span></span>
<span id="cb81-2"><a href="sec-raw.html#cb81-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filterDataOrigin</span>(fls[<span class="dv">2</span>]) <span class="sc">|&gt;</span></span>
<span id="cb81-3"><a href="sec-raw.html#cb81-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filterRt</span>(<span class="fu">c</span>(<span class="dv">175</span>, <span class="dv">189</span>))</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 50 spectra in a MsBackendMzR backend:
##       msLevel     rtime scanIndex
##     &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1           1   175.212       628
## 2           1   175.491       629
## 3           1   175.770       630
## 4           1   176.049       631
## 5           1   176.328       632
## ...       ...       ...       ...
## 46          1   187.768       673
## 47          1   188.047       674
## 48          1   188.326       675
## 49          1   188.605       676
## 50          1   188.884       677
##  ... 34 more variables/columns.
## 
## file(s):
## 20171016_POOL_POS_3_105-134.mzML
## Processing:
##  Filter: select data origin(s) /gnu/store/jva50sd5pnbdvjpya85sg9sqrrw113cl-r-msdata-0.48.0/site-library/msdata/sciex/20171016_POOL_POS_3_105-134.mzML [Thu Jun  5 17:26:00 2025]
##  Filter: select retention time [175..189] on MS level(s)  [Thu Jun  5 17:26:00 2025]</code></pre>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<p>As an example of data processing, we use below the <code>pickPeaks()</code>
function. This function allows to convert <em>profile mode</em> MS data to <em>centroid
mode</em> data (a process also referred to as <em>centroiding</em>).</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="sec-raw.html#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpectra</span>(sp[<span class="dv">2807</span>], <span class="at">xlim =</span> <span class="fu">c</span>(<span class="fl">521.2</span>, <span class="fl">522.5</span>))</span></code></pre></div>
<p><img src="R4MS_files/figure-html/unnamed-chunk-22-1.png" width="672"></p>
<p>Centroiding reduces the profile mode MS data to a <em>representative</em> single mass
peak per ion.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="sec-raw.html#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pickPeaks</span>(sp[<span class="dv">2807</span>]) <span class="sc">|&gt;</span></span>
<span id="cb84-2"><a href="sec-raw.html#cb84-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filterIntensity</span>(<span class="fl">1e7</span>) <span class="sc">|&gt;</span></span>
<span id="cb84-3"><a href="sec-raw.html#cb84-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plotSpectra</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="fl">521.2</span>, <span class="fl">522.5</span>))</span></code></pre></div>
<p><img src="R4MS_files/figure-html/unnamed-chunk-23-1.png" width="672"></p>
</div>
<div id="a-note-on-efficiency" class="section level2" number="3.4">
<h2>
<span class="header-section-number">3.4</span> A note on efficiency<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('a-note-on-efficiency')" onmouseout="reset_tooltip('a-note-on-efficiency-tooltip')"><span class="tooltiptext" id="a-note-on-efficiency-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<div id="backends-1" class="section level3" number="3.4.1">
<h3>
<span class="header-section-number">3.4.1</span> Backends<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('backends-1')" onmouseout="reset_tooltip('backends-1-tooltip')"><span class="tooltiptext" id="backends-1-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>The figure below (taken from <span class="citation">(<label for="tufte-mn-6" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-6" class="margin-toggle">Gatto, Gibb, and Rainer 2020<span class="marginnote">Gatto, Laurent, Sebastian Gibb, and Johannes Rainer. 2020. <span>“<span>MSnbase</span>, Efficient and Elegant r-Based Processing and Visualisation of Raw Mass Spectrometry Data.”</span> <em>J. Proteome Res.</em>, September.</span>)</span>) illustrates the respective
advantages of storing data in memory or on disk. The benchmarking was
done for the <code>MSnbase</code> package but also applies to the <code>Spectra</code> backends.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-24"></span>
<p class="caption marginnote shownote">
Figure 3.2: (a) Reading time (triplicates, in seconds) and (b) data size in memory (in MB) to read/store 1, 5, and 10 files containing 1431 MS1 (on-disk only) and 6103 MS2 (on-disk and in-memory) spectra. (c) Filtering benchmark assessed over 10 interactions on in-memory and on-disk data containing 6103 MS2 spectra. (d) Access time to spectra for the in-memory (left) and on-disk (right) backends for 1, 10, 100 1000, 5000, and all 6103 spectra. Benchmarks were performed on a Dell XPS laptop with an Intel i5-8250U processor 1.60 GHz (4 cores, 8 threads), 7.5 GB RAM running Ubuntu 18.04.4 LTS 64-bit, and an SSD drive. The data used for the benchmarking are a TMT 4-plex experiment acquired on a LTQ Orbitrap Velos (Thermo Fisher Scientific) available in the msdata package.
</p>
<img src="img/pr0c00313_0002.gif" alt="(a) Reading time (triplicates, in seconds) and (b) data size in memory (in MB) to read/store 1, 5, and 10 files containing 1431 MS1 (on-disk only) and 6103 MS2 (on-disk and in-memory) spectra. (c) Filtering benchmark assessed over 10 interactions on in-memory and on-disk data containing 6103 MS2 spectra. (d) Access time to spectra for the in-memory (left) and on-disk (right) backends for 1, 10, 100 1000, 5000, and all 6103 spectra. Benchmarks were performed on a Dell XPS laptop with an Intel i5-8250U processor 1.60 GHz (4 cores, 8 threads), 7.5 GB RAM running Ubuntu 18.04.4 LTS 64-bit, and an SSD drive. The data used for the benchmarking are a TMT 4-plex experiment acquired on a LTQ Orbitrap Velos (Thermo Fisher Scientific) available in the msdata package." width="70%">
</div>
</div>
<div id="parallel-processing" class="section level3" number="3.4.2">
<h3>
<span class="header-section-number">3.4.2</span> Parallel processing<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('parallel-processing')" onmouseout="reset_tooltip('parallel-processing-tooltip')"><span class="tooltiptext" id="parallel-processing-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>Most functions on <code>Spectra</code> support (and use) parallel processing out
of the box. Peak data access and manipulation methods perform by
default parallel processing on a per-file basis (i.e. using the
dataStorage variable as splitting factor). Spectra uses
<a href="https://bioconductor.org/packages/BiocParallel"><code>BiocParallel</code></a> for
parallel processing and all functions use the default registered
parallel processing setup of that package.</p>
</div>
<div id="lazy-evaluation" class="section level3" number="3.4.3">
<h3>
<span class="header-section-number">3.4.3</span> Lazy evaluation<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('lazy-evaluation')" onmouseout="reset_tooltip('lazy-evaluation-tooltip')"><span class="tooltiptext" id="lazy-evaluation-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>Data manipulations on Spectra objects are not immediately applied to
the peak data. They are added to a so called processing queue which is
applied each time peak data is accessed (with the <code>peaksData</code>, <code>mz</code> or
<code>intensity</code> functions). Thanks to this processing queue data
manipulation operations are also possible for read-only backends
(e.g. mzML-file based backends or database-based backends). The
information about the number of such processing steps can be seen
below (next to Lazy evaluation queue).</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="sec-raw.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(<span class="fu">intensity</span>(sp_sciex[<span class="dv">1</span>]))</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="sec-raw.html#cb87-1" aria-hidden="true" tabindex="-1"></a>sp_sciex <span class="ot">&lt;-</span> <span class="fu">filterIntensity</span>(sp_sciex, <span class="at">intensity =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="cn">Inf</span>))</span>
<span id="cb87-2"><a href="sec-raw.html#cb87-2" aria-hidden="true" tabindex="-1"></a>sp_sciex <span class="do">## Note the lazy evaluation queue</span></span></code></pre></div>
<pre><code>## MSn data (Spectra) with 1862 spectra in a MsBackendMzR backend:
##        msLevel     rtime scanIndex
##      &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1            1     0.280         1
## 2            1     0.559         2
## 3            1     0.838         3
## 4            1     1.117         4
## 5            1     1.396         5
## ...        ...       ...       ...
## 1858         1   258.636       927
## 1859         1   258.915       928
## 1860         1   259.194       929
## 1861         1   259.473       930
## 1862         1   259.752       931
##  ... 34 more variables/columns.
## 
## file(s):
## 20171016_POOL_POS_1_105-134.mzML
## 20171016_POOL_POS_3_105-134.mzML
## Lazy evaluation queue: 1 processing step(s)
## Processing:
##  Remove peaks with intensities outside [10, Inf] in spectra of MS level(s) 1. [Thu Jun  5 17:26:01 2025]</code></pre>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="sec-raw.html#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(<span class="fu">intensity</span>(sp_sciex[<span class="dv">1</span>]))</span></code></pre></div>
<pre><code>## [1] 412</code></pre>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="sec-raw.html#cb91-1" aria-hidden="true" tabindex="-1"></a>sp_sciex<span class="sc">@</span>processingQueue</span></code></pre></div>
<pre><code>## [[1]]
## Object of class "ProcessingStep"
##  Function: user-provided function
##  Arguments:
##   o intensity = 10Inf
##   o msLevel = 1</code></pre>
<p>Through this lazy evaluation system it is also possible to <em>undo</em> data
manipulations:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="sec-raw.html#cb93-1" aria-hidden="true" tabindex="-1"></a>sp_sciex <span class="ot">&lt;-</span> <span class="fu">reset</span>(sp_sciex)</span>
<span id="cb93-2"><a href="sec-raw.html#cb93-2" aria-hidden="true" tabindex="-1"></a>sp_sciex<span class="sc">@</span>processingQueue</span></code></pre></div>
<pre><code>## list()</code></pre>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="sec-raw.html#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(<span class="fu">intensity</span>(sp_sciex[<span class="dv">1</span>]))</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>More information on this lazy evaluation concept implemented in <code>Spectra</code> is
provided in the <a href="https://jorainer.github.io/SpectraTutorials/articles/Spectra-backends.html">Spectra
backends</a>
vignette.</p>

</div>
</div>
</div>
<p style="text-align: center;">
<a href="sec-msintro.html"><button class="btn btn-default">Previous</button></a>
<a href="sec-id.html"><button class="btn btn-default">Next</button></a>
</p>
<p class="build-date">Page built: 
2025-06-05
 using 
R version 4.5.0 (2025-04-11)
</p>
</div>
</div>



</body>
</html>
